# é™æ€èµ„æºåŒæ­¥

## rsync

`rsync` æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„æ–‡ä»¶åŒæ­¥å·¥å…·ï¼Œé€‚ç”¨äº**é™æ€èµ„æºåŒæ­¥**ï¼Œä¾‹å¦‚ Web æœåŠ¡å™¨ä¹‹é—´çš„ HTMLã€CSSã€JSã€å›¾ç‰‡ç­‰æ–‡ä»¶çš„åˆ†å‘ã€‚

------

## **1. åŸºæœ¬ç”¨æ³•**

### **æœ¬åœ°ç›®å½•åŒæ­¥**

å°† `src_dir/` åŒæ­¥åˆ° `dest_dir/`ï¼š

```sh
rsync -av src_dir/ dest_dir/
```

å‚æ•°è¯´æ˜ï¼š

- `-a`ï¼ˆ**archive**ï¼‰ï¼šä¿ç•™æ–‡ä»¶æƒé™ã€æ—¶é—´æˆ³ã€è½¯é“¾æ¥ç­‰
- `-v`ï¼ˆ**verbose**ï¼‰ï¼šæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
- `/`ï¼ˆ**æœ«å°¾æ–œæ **ï¼‰ï¼šé¿å…åˆ›å»ºå¤šä½™çš„åµŒå¥—ç›®å½•

ç¤ºä¾‹ï¼š

```sh
rsync -av /var/www/static/ /backup/static/
```

------

## **2. è¿œç¨‹æœåŠ¡å™¨åŒæ­¥**

### **æ–¹å¼ 1ï¼šåŸºäº SSH**

ä»æœ¬åœ°åŒæ­¥åˆ°è¿œç¨‹ï¼š

```sh
rsync -av -e "ssh -p 22" /var/www/static/ user@remote_server:/var/www/static/
```

ä»è¿œç¨‹åŒæ­¥åˆ°æœ¬åœ°ï¼š

```sh
rsync -av -e "ssh -p 22" user@remote_server:/var/www/static/ /var/www/static/
```

- `-e "ssh -p 22"`ï¼šæŒ‡å®š SSH ç«¯å£ï¼ˆé»˜è®¤ `22`ï¼‰

- ç¤ºä¾‹

  ï¼ˆåŒæ­¥åˆ° CDN æœåŠ¡å™¨ï¼‰ï¼š

  ```sh
  rsync -av -e "ssh -p 22022" /var/www/static/ deploy@cdn.example.com:/var/www/static/
  ```

------

### **æ–¹å¼ 2ï¼šåŸºäº `rsync` å®ˆæŠ¤è¿›ç¨‹**

å¦‚æœç›®æ ‡æœåŠ¡å™¨å·²è¿è¡Œ `rsync` å®ˆæŠ¤è¿›ç¨‹ï¼Œå¯ä½¿ç”¨ï¼š

```sh
rsync -av rsync://remote_server/module_name/ /local/dir/
```

- éœ€åœ¨ `/etc/rsyncd.conf` é…ç½® `module_name`
- é€‚åˆé«˜æ€§èƒ½æ–‡ä»¶åˆ†å‘ï¼ˆå¦‚ Web é›†ç¾¤ï¼‰

------

## **3. æ–­ç‚¹ç»­ä¼ **

å½“ä¼ è¾“å¤§æ–‡ä»¶æ—¶ï¼Œå¯å¯ç”¨**æ–­ç‚¹ç»­ä¼ **ï¼š

```sh
rsync -av --partial --progress src_dir/ user@remote_server:/dest_dir/
```

- `--partial`ï¼šä¿ç•™æœªå®Œæˆçš„æ–‡ä»¶
- `--progress`ï¼šæ˜¾ç¤ºè¿›åº¦

------

## **4. åˆ é™¤ç›®æ ‡ä¸­å¤šä½™çš„æ–‡ä»¶**

å¦‚æœç›®æ ‡ç›®å½•æœ‰**å¤šä½™çš„æ–‡ä»¶**ï¼Œå¯ä»¥ä½¿ç”¨ `--delete` é€‰é¡¹ï¼š

```sh
rsync -av --delete /var/www/static/ user@remote_server:/var/www/static/
```

- è¿™æ ·ï¼Œ`/var/www/static/` é‡Œ**ä¸å­˜åœ¨çš„æ–‡ä»¶**ï¼Œä¼šåœ¨ `remote_server:/var/www/static/` **è¢«åˆ é™¤**ã€‚

------

## **5. åªåŒæ­¥ä¿®æ”¹è¿‡çš„æ–‡ä»¶**

å¯¹äº**é™æ€èµ„æºå¢é‡æ›´æ–°**ï¼Œå¯ä»¥ä½¿ç”¨ `-u`ï¼ˆä»…åŒæ­¥è¾ƒæ–°çš„æ–‡ä»¶ï¼‰ï¼š

```sh
rsync -avu /var/www/static/ user@remote_server:/var/www/static/
```

------

## **6. æ’é™¤ç‰¹å®šæ–‡ä»¶**

å¦‚æœä¸æƒ³åŒæ­¥ `.git`ã€`node_modules`ã€æ—¥å¿—ç­‰ï¼Œå¯ä»¥ä½¿ç”¨ `--exclude`ï¼š

```sh
rsync -av --exclude ".git/" --exclude "node_modules/" /var/www/static/ user@remote_server:/var/www/static/
```

æˆ–ä½¿ç”¨ `--exclude-from` æŒ‡å®šæ’é™¤åˆ—è¡¨ï¼š

```sh
echo ".git/" > exclude-list.txt
echo "node_modules/" >> exclude-list.txt
rsync -av --exclude-from="exclude-list.txt" /var/www/static/ user@remote_server:/var/www/static/
```

------

## **7. é…åˆ `crontab` è‡ªåŠ¨å®šæ—¶åŒæ­¥**

åœ¨æœåŠ¡å™¨ä¸Šå¯ä»¥ä½¿ç”¨ `crontab` å®šæ—¶æ‰§è¡Œ `rsync`ï¼š

```sh
crontab -e
```

æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆæ¯ 5 åˆ†é’ŸåŒæ­¥ä¸€æ¬¡ï¼‰ï¼š

```sh
*/5 * * * * rsync -av --delete /var/www/static/ user@remote_server:/var/www/static/
```

------

## **æ€»ç»“**

| åœºæ™¯                 | `rsync` å‘½ä»¤                                             |
| -------------------- | -------------------------------------------------------- |
| æœ¬åœ°åŒæ­¥             | `rsync -av src/ dest/`                                   |
| SSH è¿œç¨‹åŒæ­¥         | `rsync -av -e "ssh -p 22" src/ user@server:/dest/`       |
| æ–­ç‚¹ç»­ä¼              | `rsync -av --partial --progress src/ user@server:/dest/` |
| åˆ é™¤ç›®æ ‡ä¸­å¤šä½™çš„æ–‡ä»¶ | `rsync -av --delete src/ user@server:/dest/`             |
| å¢é‡åŒæ­¥             | `rsync -avu src/ user@server:/dest/`                     |
| æ’é™¤æ–‡ä»¶             | `rsync -av --exclude ".git/" src/ user@server:/dest/`    |
| å®šæ—¶åŒæ­¥             | `crontab -e` + `rsync -av ...`                           |

`rsync` æ˜¯é«˜æ•ˆçš„é™æ€èµ„æºåŒæ­¥å·¥å…·ï¼Œé€‚ç”¨äº Web æœåŠ¡å™¨é—´çš„æ–‡ä»¶åˆ†å‘ã€CDN æ¨é€ç­‰ä»»åŠ¡ã€‚

## inotify

### **ä½¿ç”¨ `inotify` + `rsync` å®ç°å®æ—¶åŒæ­¥**

`inotify` æ˜¯ Linux å†…æ ¸æä¾›çš„**æ–‡ä»¶ç³»ç»Ÿç›‘æ§æœºåˆ¶**ï¼Œå¯ä»¥ç›‘å¬**æ–‡ä»¶å˜åŒ–**ï¼ˆæ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤ç­‰ï¼‰ï¼Œé…åˆ `rsync` å®ç°**å®æ—¶åŒæ­¥**ã€‚

é€‚ç”¨åœºæ™¯ï¼š

- **Web æœåŠ¡å™¨é™æ€èµ„æºåŒæ­¥**
- **æ•°æ®å¤‡ä»½**
- **é«˜å¯ç”¨æ–‡ä»¶åˆ†å‘ï¼ˆHAï¼‰**

### **1. å®‰è£… `inotify-tools`**

`inotify` ç›¸å…³å·¥å…· `inotify-tools` é»˜è®¤ä¸å®‰è£…ï¼Œéœ€è¦æ‰‹åŠ¨å®‰è£…ï¼š

```sh
sudo apt update
sudo apt install -y inotify-tools rsync
```

### **2. ä½¿ç”¨ `inotifywait` ç›‘å¬æ–‡ä»¶å˜åŒ–**

`inotifywait` å¯ä»¥ç›‘æ§ç›®å½•å˜åŒ–ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```sh
inotifywait -mrq --format '%w%f' -e modify,create,delete /var/www/static/
```

å‚æ•°è¯´æ˜ï¼š

- `-m`ï¼šæŒç»­ç›‘å¬ï¼ˆé»˜è®¤ç›‘å¬ä¸€æ¬¡åé€€å‡ºï¼‰
- `-r`ï¼šé€’å½’ç›‘å¬å­ç›®å½•
- `-q`ï¼šé™é»˜æ¨¡å¼ï¼Œä¸è¾“å‡ºå¤šä½™ä¿¡æ¯
- `--format '%w%f'`ï¼šè¾“å‡ºå®Œæ•´æ–‡ä»¶è·¯å¾„
- `-e modify,create,delete`ï¼šç›‘å¬ä¿®æ”¹ã€åˆ›å»ºå’Œåˆ é™¤äº‹ä»¶

### **3. é…åˆ `rsync` å®ç°å®æ—¶åŒæ­¥**

å¯ä»¥ä½¿ç”¨ `inotifywait` ç›‘å¬æ–‡ä»¶å˜æ›´å**è‡ªåŠ¨æ‰§è¡Œ `rsync`**ï¼š

```sh
#!/bin/bash

SRC_DIR="/var/www/static/"
DEST_USER="user"
DEST_HOST="192.168.1.100"
DEST_DIR="/var/www/static/"

inotifywait -mrq -e modify,create,delete,move "$SRC_DIR" | while read file
do
    rsync -avz --delete "$SRC_DIR" "$DEST_USER@$DEST_HOST:$DEST_DIR"
    echo "$(date) - Synced $SRC_DIR to $DEST_HOST:$DEST_DIR"
done
```

**ä¿å­˜è„šæœ¬**ï¼š

```sh
sudo nano /usr/local/bin/rsync_inotify.sh
```

**èµ‹äºˆæ‰§è¡Œæƒé™**ï¼š

```sh
sudo chmod +x /usr/local/bin/rsync_inotify.sh
```

**è¿è¡Œè„šæœ¬**ï¼š

```sh
nohup /usr/local/bin/rsync_inotify.sh > /var/log/rsync_inotify.log 2>&1 &
```

### **4. é…ç½® `systemd` ä½¿ `rsync` æŒç»­è¿è¡Œ**

åˆ›å»º `systemd` æœåŠ¡æ–‡ä»¶ï¼š

```sh
sudo nano /etc/systemd/system/rsync_inotify.service
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```ini
[Unit]
Description=Realtime Rsync with inotify
After=network.target

[Service]
ExecStart=/usr/local/bin/rsync_inotify.sh
Restart=always
User=root

[Install]
WantedBy=multi-user.target
```

**å¯ç”¨æœåŠ¡**ï¼š

```sh
sudo systemctl daemon-reload
sudo systemctl enable rsync_inotify
sudo systemctl start rsync_inotify
```

**æŸ¥çœ‹çŠ¶æ€**ï¼š

```sh
sudo systemctl status rsync_inotify
```

### **5. è¿œç¨‹å…å¯†ç™»å½•ï¼ˆSSH å…å¯†é’¥ï¼‰**

ä¸ºäº†é¿å… `rsync` æ¯æ¬¡åŒæ­¥éƒ½éœ€è¦è¾“å…¥å¯†ç ï¼Œå¯ä»¥é…ç½®**SSH å…å¯†ç™»å½•**ï¼š

```sh
ssh-keygen -t rsa -b 4096
ssh-copy-id user@192.168.1.100
```

æˆåŠŸåï¼Œ`rsync` å¯ä»¥ç›´æ¥è¿è¡Œï¼Œæ— éœ€è¾“å…¥å¯†ç ã€‚

### **6. æ—¥å¿—å’Œè°ƒè¯•**

**æŸ¥çœ‹ `rsync` æ—¥å¿—**

```sh
tail -f /var/log/rsync_inotify.log
```

**æŸ¥çœ‹ `systemd` æ—¥å¿—**

```sh
journalctl -u rsync_inotify -f
```

### **7. `inotify` é™åˆ¶ä¼˜åŒ–**

Linux é»˜è®¤ `inotify` ç›‘å¬æ•°è¾ƒå°ï¼Œå¯é€šè¿‡ä»¥ä¸‹æ–¹å¼å¢åŠ ï¼š

```sh
echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf
echo fs.inotify.max_user_instances=1024 | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

### **æ€»ç»“**

| æ­¥éª¤                         | å‘½ä»¤                                        |
| ---------------------------- | ------------------------------------------- |
| å®‰è£… `inotify-tools`         | `sudo apt install inotify-tools rsync`      |
| åˆ›å»º `rsync_inotify.sh` è„šæœ¬ | `sudo nano /usr/local/bin/rsync_inotify.sh` |
| è¿è¡Œè„šæœ¬                     | `nohup /usr/local/bin/rsync_inotify.sh &`   |
| é…ç½® `systemd`               | `sudo systemctl enable rsync_inotify`       |
| é…ç½® SSH å…å¯†ç™»å½•            | `ssh-keygen && ssh-copy-id user@remote`     |
| è°ƒæ•´ `inotify` é™åˆ¶          | `sudo sysctl -p`                            |

è¿™æ ·ï¼Œ`inotify` + `rsync` å°±å¯ä»¥å®ç°**é«˜æ•ˆã€å®æ—¶çš„æ–‡ä»¶åŒæ­¥**ğŸš€ï¼